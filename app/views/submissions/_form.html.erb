<%= form_for [@course, @assignment, @submission] do |f| %>
  <%= f.hidden_field :assignment_id %>
  <%= f.hidden_field :user_id %>

  <% if @submission.errors.any? %>
    <div id="error_explanation" class="alert alert-danger">
      <h2><%= pluralize(@submission.errors.count, "error") %> prohibited this submission from being saved:</h2>

      <ul>
      <% @submission.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Assignment description</h3>
      </div>
      <div class="panel-body">
        <div class="prose">
          <%= raw @assignment.assignment %>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-12">
  <% allowed = @assignment.sub_allow_submission?(@submission)
     staff_override = true_user.course_staff?(@course)
     %>
  <% if @team.nil? && @assignment.team_subs? %>
    <div class="alert alert-danger">
      <p>This assignment requires team submissions,
        and you are not currently in a team.</p>
      <% if staff_override %>
      <p>You need to 
        <%= link_to "enroll the student in a team",
        new_course_team_path(@course) %>
        before submitting.</p>
      <% else %>
      <p>Contact a professor to join a team.</p>
      <% end %>
    </div>
  <% elsif !allowed && !staff_override %>
    <div class="alert alert-danger">
      <p>It's too late to submit to this assignment: you either have
        too few late days remaining, or it's too long after the
        assignment is due.</p>
    </div> 
  <% else %>
    <% if !allowed && staff_override %>
    <div class="alert alert-info">
      <p>You are submitting on behalf of a student.  Should this assignment
        be exempt from lateness penalties?
        <%= f.check_box :ignore_late_penalty, :checked => "checked",
                        data: {toggle: "toggle", on: "Yes", off: "No"} %>
      </p>
      <p>If lateness is not ignored, this assignment should claim to
        have been submitted at:</p>
      <div class="row">
        <div class="col-sm-6">
          <%= f.text_field :created_at, class: 'form-control', disabled: "disabled" %>
        </div>
        <script type="text/javascript">
          $(function () {
            $('#submission_created_at').datetimepicker({
              sideBySide: true,
              format: "YYYY/MM/DD h:mm A",
              minDate: "<%= @course.created_at.strftime("%Y-%m-%d") %>",
              defaultDate: "<%= DateTime.current.strftime("%Y-%m-%d %H:%M") %>"
            });
            $('#submission_ignore_late_penalty').on("change", function() {
              if ($(this).prop("checked"))
                $('#submission_created_at').prop("disabled", true);
              else
                $('#submission_created_at').prop("disabled", false);
            });
          });
        </script>
      </div>      
    </div>
    <% end %>
  </div>
  
    <% if @team.nil? %>
    <p>This will be an individual submission.</p>
    <% else %>
    <p>This will be a team submission for <strong><%= @team %></strong>.</p>
    <% end %>

    <div class="form-group">
      <%= f.label :student_notes %>
      <%= f.text_area :student_notes, class: 'form-control' %>
    </div>
    <div class="form-group">
      <%= f.label :upload_file %>
      <%= f.file_field :upload_file %>
    </div>
    <div class="form-group">
      <%= f.submit nil, class: "btn btn-primary" %>
    </div>
  <% end %>
<% end %>
