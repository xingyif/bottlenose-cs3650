<% @page_title = "View Submission" %>
<% cur_reg = current_user.registration_for(@course) %>
<% def maybe_link_to(which, text, link)
     if which then link_to(text, link) else text end
   end %>

<p>
  <%= link_to "Back to Assignment: #{@assignment.name}", course_assignment_path(@course, @assignment) %>
</p>

<h1>Submission</h1>

<table class="table row-vcenter">
  <tr>
    <td><strong>Assignment</strong></td>
    <td><%= @submission.assignment.name %></td>
  </tr>
  <% if @submission.team.nil? %>
    <tr>
      <td><strong>Student</strong></td>
      <td><%= maybe_link_to cur_reg.staff?, @submission.user.name, user_path(@submission.user) %></td>
    </tr>
  <% else %>
    <tr>
      <td><strong>Team</strong></td>
      <td><%= maybe_link_to cur_reg.staff?, @submission.team, course_team_path(@course, @submission.team) %>
        (submitted by <%= maybe_link_to cur_reg.staff?, @submission.user.name, user_path(@submission.user) %>)</td>
    </tr>
  <% end %>
  <tr>
    <td><strong>Submission Time</strong></td>
    <td><span class="local-time"><%= @submission.created_at %></span></td>
  </tr>
  <tr>
    <td><strong>Submission Details</strong></td>
    <td><%= link_to "See individual files",
            details_course_assignment_submission_path(@course, @assignment, @submission),
            class: "btn btn-success" %>
      <%= link_to @submission.file_path, class: "btn btn-default" do %>
      <i class="glyphicon glyphicon-download-alt"></i> Download  <%= @submission.file_name %> 
      <% end %>
    </td>
  </tr>
  <tr>
    <td><strong>Student Notes</strong></td>
    <td>
      <div class="prose"><%= @submission.student_notes %></div>
    </td>
  </tr>
</table>

<h1>Scoring Details</h1>

<table class="table table-striped row-vcenter">
  <% grades = @gradesheet.grades[:grades].find(sub: @submission).first
     all_scores = if cur_reg.staff? then grades[:staff_scores] else grades[:blind_scores] end
     graders = @gradesheet.graders[@submission.id]
     unavailable = (graders and !(graders.all?(&:available)))
     complete = (graders and graders.all?(&:complete?))
     @gradesheet.configs.each_with_index do |c, i|
       scores = all_scores[:scores][i]
       grader = (graders and graders.find{|gr| gr.grader_config_id == c.id})
     %>
  <tr>
    <td><%= c.type %></td>
    <td>
      <% if scores.kind_of?(Array) %>
      <%= show_score(scores[0], @gradesheet.assignment, cur_reg.staff?) %>&nbsp;/&nbsp;<%= to_fixed(scores[1]) %>
      <% if scores[-1] == "hidden" %> (hidden) <% end %>
      <% else %>
      <%= scores %>
      <% end %>
    </td>
    <td>
      <% if cur_reg.staff? %>
        <% if grader.nil? %>
          Missing
          <%= link_to "Create grader",
              recreate_grader_course_assignment_submission_path(@course, @assignment, @submission, @gradesheet.configs[i]),
              method: 'post', class: "btn btn-warning" %>
        <% else %>
          <%= link_to "Grader output", 
              course_assignment_submission_grader_path(@course, @assignment, @submission, grader) %>
          <%= if !grader.available then " (unavailable)"
              elsif !grader.complete? then " (hidden)" end %>
          <% if c.autograde? %>
            <%= link_to "Rerun autograder", 
                regrade_course_assignment_submission_grader_path(@course, @assignment, @submission, grader),
                method: 'post', class: "btn btn-default", style: "margin-left: 5em;" %>
          <% else %>
            <% if grader.complete? %>
            <%= link_to "Regrade",
                edit_course_assignment_submission_grader_path(@course, @assignment, @submission, grader),
                class: "btn btn-info", style: "margin-left: 5em;"%>
            <% else %>
            <%= link_to "Grade",
                edit_course_assignment_submission_grader_path(@course, @assignment, @submission, grader),
                class: "btn btn-success", style: "margin-left: 5em;" %>
            <% end %>
          <% end %>
        <% end %>  
      <% else %>
        <% if grader && grader.available %>
          <%= link_to "Grader output",
              course_assignment_submission_grader_path(@course, @assignment, @submission, grader) %>
        <% else %>
          No grader available
        <% end %>
      <% end %>
    </td>
  </tr>
  <% end %>
  <tr>
    <td>Raw Score:</td>
    <td>
      <% if all_scores[:raw_score].nil? %>
      <%= image_tag("question-mark.png", height: 16) %>&nbsp;/&nbsp;<%= to_fixed(@gradesheet.max_score) %>
      <% else %>
      <%= to_fixed(all_scores[:raw_score]) %>&nbsp;/&nbsp;<%= to_fixed(@gradesheet.max_score) %>
      <%= if !complete then " (hidden)" end %>
      <% end %>
    </td>
    <td></td>
  </tr>
  <tr>
    <td>Raw Percentage</td>
    <td>
      <% if all_scores[:raw_score].nil? %>
      <%= image_tag("question-mark.png", height: 16) %>
      <% else %>
      <%= to_fixed(100.0 * (all_scores[:raw_score] / @gradesheet.max_score)) %>%
      <%= if !complete then " (hidden)" end %>
      <% end %>
    </td>
    <td></td>
  </tr>
  <% if @submission.late? or @submission.ignore_late_penalty %>
  <tr>
    <td>Days Late:</td>
    <td><%= @submission.days_late(true) %></td>
    <td></td>
  </tr>
  <tr>
    <td>Late Penalty:</td>
    <td><%= to_fixed(@submission.late_penalty) %>%</td>
    <td>
      <%= if @submission.ignore_late_penalty
            "(penalty ignored)"
          elsif @submission.days_late > 0
            link_to("Rescind lateness penalty",
              rescind_lateness_course_assignment_submission_path(@course, @assignment, @submission),
              class: "btn btn-default", method: "patch")
          end
          %>
    </td>
  </tr>
  <% end %>
  <tr>
    <td>Total Score:</td>
    <td>
      <% if !all_scores[:raw_score].nil? %>
      <%= show_score(@submission.score, @gradesheet.assignment, cur_reg.staff?) %>%
      <% if !complete then %>
      (hidden)
      <% end %>
      <% else %>
      <%= image_tag("question-mark.png", height: 16) %>
      <% end %>
    </td>
    <td>
      <% if cur_reg.staff? %>
        <% if @gradesheet.assignment.due_date > DateTime.now %>
        <span class="btn btn-default disabled">Cannot publish grades before assignment is due</span>
        <% elsif complete && unavailable %>
        <%= link_to "Publish grades", 
            publish_course_assignment_submission_path(@course, @gradesheet.assignment, @submission), class: "btn btn-default",
            method: 'patch',
            data: { confirm: "Are you sure you want to publish grades for this submission?" }%>
        <% elsif !complete %>
        <span class="btn btn-default disabled">Finish grading before publishing score</span>
        <% end %>
      <% end %>
    </td>
  </tr>
</table>

<% show_hidden = (current_user.site_admin? || cur_reg.staff?)
   sub_comments = @submission.grader_submission_comments(show_hidden)
   if sub_comments.count > 0 %>
<h1>General comments</h1>
<div class="row">
<div class="col-sm-12"> 
<% sub_comments.each do |file, comments| %>
<h3><%= if file == @submission.upload.extracted_path.to_s then "Overall" else file end %>:</h3>
  <% comments.each do |c| %>
  <div class="<%= "#{c.severity.humanize(:capitalize => false)} #{c.grader.grader_config.type.humanize}" %>">
  <span class="label label-default">- <%= to_fixed(c.weight) %></span>
  <span class="description"><%= c.title %>: <%= c.comment %></span>
</div>
    <% end %>
  <% end %>
</div>
</div>
<p>&nbsp;</p>
<% end %>
